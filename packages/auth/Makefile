.PHONY: help install dev build test lint format clean
.PHONY: auth-up auth-down db-up db-down services-up services-down
.PHONY: test-unit test-e2e test-all test-watch
.PHONY: api-dev ui-dev deps-install

# Default target
help: ## Show this help message
	@echo "ğŸ” Authentication Development Commands"
	@echo "====================================="
	@awk 'BEGIN {FS = ":.*##"; printf "\n"} /^[a-zA-Z_-]+:.*?##/ { printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2 } /^##@/ { printf "\n\033[1m%s\033[0m\n", substr($$0, 5) } ' $(MAKEFILE_LIST)

##@ ğŸš€ Quick Start
install: ## Install all dependencies (Node + Python)
	cd ../.. && pnpm setup

dev: services-up ## Start full development environment
	@echo "ğŸš€ Starting development environment..."
	@echo "ğŸ“Š UI: http://localhost:5173"
	@echo "ğŸ”Œ API: http://localhost:8000"
	@echo "ğŸ” Keycloak: http://localhost:8080"
	cd ../.. && pnpm dev

##@ ğŸ”§ Services Management  
auth-up: ## Start Keycloak authentication service
	@echo "ğŸ” Starting Keycloak..."
	podman compose up -d
	@echo "â³ Waiting for Keycloak to be ready..."
	@timeout 60 bash -c 'until curl -f http://localhost:8080/health/ready >/dev/null 2>&1; do sleep 2; done' || true
	@echo "âœ… Keycloak is ready at http://localhost:8080"

auth-down: ## Stop Keycloak authentication service
	podman compose down

auth-logs: ## Show Keycloak logs
	podman compose logs -f keycloak

auth-restart: ## Restart Keycloak
	podman compose restart keycloak

db-up: ## Start PostgreSQL database
	@echo "ğŸ—„ï¸  Starting database..."
	cd ../.. && pnpm db:start
	@echo "â³ Waiting for database to be ready..."
	@sleep 5
	cd ../.. && pnpm db:upgrade
	@echo "âœ… Database is ready"

db-down: ## Stop PostgreSQL database  
	cd ../.. && pnpm db:stop

services-up: auth-up db-up ## Start all services (Keycloak + Database)
	@echo "ğŸ‰ All services are running!"

services-down: auth-down db-down ## Stop all services
	@echo "ğŸ›‘ All services stopped"

##@ ğŸ§ª Testing
test-deps: ## Install test dependencies
	uv pip install -r requirements.txt

test-unit: ## Run unit tests only
	@echo "ğŸ§ª Running auth unit tests..."
	source .venv/bin/activate && python -m pytest tests/ -v

test-e2e: services-up ## Run end-to-end tests (requires services)
	@echo "ğŸ­ Running E2E tests..."
	@echo "â³ Waiting for services to be ready..."
	@sleep 10
	source .venv/bin/activate && python scripts/test_e2e.py
	
test-all: test-unit ## Run all tests
	@echo "âœ… All tests completed"

test-watch: ## Run tests in watch mode
	source .venv/bin/activate && python -m pytest tests/ -v --tb=short -f

test-coverage: ## Run tests with coverage report
	@echo "ğŸ“Š Running tests with coverage..."
	source .venv/bin/activate && python -m pytest tests/ --cov-report=html:htmlcov --cov-report=term-missing
	@echo "ğŸ“‹ Coverage report: htmlcov/index.html"

##@ ğŸ¯ Development
api-dev: ## Start API development server only
	cd ../.. && pnpm --filter @spending-monitor/api dev

ui-dev: ## Start UI development server only  
	cd ../.. && pnpm --filter @spending-monitor/ui dev

##@ ğŸ” Code Quality
lint: ## Run linting on auth code
	cd ../.. && pnpm lint

lint-fix: ## Fix linting issues automatically
	cd ../.. && pnpm lint:fix

format: ## Format all code
	cd ../.. && pnpm format

format-check: ## Check code formatting
	cd ../.. && pnpm format:check

##@ ğŸ” Authentication Setup
auth-setup: auth-up ## Setup Keycloak with automated configuration
	@echo "ğŸ”§ Setting up Keycloak configuration..."
	@echo "â³ Waiting for Keycloak to be fully ready..."
	@sleep 10
	@echo "ğŸ¤– Running automated setup script..."
	source .venv/bin/activate && python scripts/setup_keycloak.py
	@echo "âœ… Keycloak setup completed!"
	@echo "ğŸ“‹ Created:"
	@echo "   â€¢ Realm: spending-monitor"
	@echo "   â€¢ Client: spending-monitor (OIDC, PKCE enabled)"
	@echo "   â€¢ Test user: testuser@example.com / password123"
	@echo "   â€¢ Roles: user, admin"

auth-test: auth-up ## Test authentication with real endpoints
	@echo "ğŸ” Testing authentication endpoints..."
	@sleep 5
	@echo "ğŸ” For comprehensive auth testing, use: make test-e2e"
	@echo "ğŸ“‹ Manual verification:"
	@echo "   â€¢ OIDC config: http://localhost:8080/realms/spending-monitor/.well-known/openid-configuration"
	@echo "   â€¢ JWKS: http://localhost:8080/realms/spending-monitor/protocol/openid-connect/certs"

##@ ğŸ“Š Monitoring & Logs
status: ## Show status of all services
	@echo "ğŸ“Š Service Status:"
	@echo "==================="
	@curl -sf http://localhost:8000/health 2>/dev/null && echo "âœ… API (8000)" || echo "âŒ API (8000)"
	@curl -sf http://localhost:8080/health/ready 2>/dev/null && echo "âœ… Keycloak (8080)" || echo "âŒ Keycloak (8080)"  
	@curl -sf http://localhost:5173 2>/dev/null && echo "âœ… UI (5173)" || echo "â„¹ï¸  UI (5173) - start with: pnpm dev:vite"

##@ ğŸ­ Demo & Examples  
demo: services-up ## Start demo environment with sample data
	@echo "ğŸ­ Starting demo environment..."
	cd ../.. && pnpm db:seed
	$(MAKE) dev

demo-auth: auth-up api-dev ## Demo authentication flow only
	@echo "ğŸ” Authentication demo ready!"
	@echo "ğŸ“‹ Test endpoints:"
	@echo "   GET http://localhost:8000/auth-demo/public"
	@echo "   GET http://localhost:8000/auth-demo/protected (requires auth)"
	@echo "ğŸ“– See README.md for Keycloak setup"
	@echo ""
	@echo "ğŸ’¡ To start the UI separately:"
	@echo "   cd ../ui && pnpm dev:vite    # UI only at http://localhost:5173"
	@echo "   cd ../.. && pnpm dev         # Full dev environment (UI + API + services)"

##@ ğŸ—ï¸  Build & Deploy
clean: ## Clean build artifacts and caches
	rm -rf htmlcov .coverage .pytest_cache
	rm -rf __pycache__ tests/__pycache__

##@ ğŸš€ CI/CD Simulation
ci-test: ## Run tests as they would in CI
	$(MAKE) clean
	$(MAKE) install  
	$(MAKE) test-all

ci-e2e: ## Run E2E tests as they would in CI
	$(MAKE) services-up
	$(MAKE) test-e2e
	$(MAKE) services-down